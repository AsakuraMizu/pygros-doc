# 如何写谱

如果你不愿意看说明文档，而更喜欢直接上手的话，我建议你去查看 `demo.py` 的代码。这里面几乎包含了 pygros 的所有特性。

接下来我们将一一讲解。

## 制谱流程

### 大体框架

```python
from phigros import *
Offset(0.1)
with Multiplier(60 / 222.22):
    with Line(0.5, 0.5) as line:
        Click(1, 0, 0.8).set(0.5, pos=0).set(0.6, pos=0.1)
        # more notes
        line.set(0.5, y=0.5).set(1, y=0.8)
preview()
```

### 1. 创建谱面文件。

在 `demo.py` 同一文件夹下创建一个 `xxx.py` 文件（名字任意）。

然后打开这个文件，开始写谱。

### 2. 加载 pygros

在文件的第一行输入：
```python
from phigros import *
```

### 3. 延迟

pygros 使用 `Offset` 来实现延迟调节。

在下一行输入：
```python
Offset(0.1)
```
即可使整个谱面推迟 0.1 秒。更多说明见 [Offset](#offset) 和 [API - Offset](/zh/api.md#offset)。

### 4. 控制 bpm

pygros 使用 `Multiplier` 来实现 bpm 控制。阅读 [API - Multiplier](/zh/api.md#multiplier) 获取更多信息。

对于最简单的使用，你可以这样写：（假设 bpm 是 222.22）
```python
with Multiplier(60 / 222.22):
    # 在这里写你之后的谱，记得每行前面要加四个空格
```

这样，当你把音符触摸时间或者动画触发时间设为 `1` 的时候，那么它实际上表示的是第 1 拍，而不是第 1 秒。

:::tip
为什么是 `60 / 222.22` 呢？

我们知道，BPM 的定义是“每分钟节拍数”，而 1 分钟有 60 秒，所以 1 拍的时间就是 `60 / 222.22`。
:::

### 5. 创建判定线

创建判定线有很多种方式，因为在这里我们使用了 Python 的上下文管理器特性。

因为这不是重点，所以我们直接简单介绍几种创建判定线的方式：（更多信息见 [API - Line](/zh/api.md#line)）

#### 方法一
```python
with Line(0.5, 0.5):
    Click(0, 0, 0.8)
    # ...
```
这是最简单的方式。它只能用于创建一条固定判定线。

#### 方法二
```python
with Line(0.5, 0.5) as line:
    Click(0, 0, 0.8)
    # ...
    # 判定线动画！
    line.set(1, angle=180)
```
这种方式较高级一些，它支持判定线动画。

#### 方法三
```python
line = Line(0.5, 0.5)
with line:
    Click(0, 0, 0.8)
    # ...
    # 可以写在里面
    line.set(1, angle=180)
# 也可以写在外面
line.set(5, angle=360)
# 可以多次使用！
with line:
    Click(5, 0, 0.8)
    # ...
    line.set(6, angle=180)
line.set(7, angle=360)
```
```python
# 也可以不使用上下文管理器特性
line = Line(0.5, 0.5)
Click(9, 0, 0.8, line=line)
```
一般用来解决一些复杂的问题。如果只是做一些简单的动画，推荐使用第二种方式。

### 6. 创建音符

音符有四种类型：`Click` `Drag` `Flick` `Hold`，其中前三种音符的参数都相同，`Hold` 额外多一个时间长度的参数。详见 [API - Click, Drag, Flick](/zh/api.md#click-drag-flick) 和 [API - Hold](/zh/api.md#hold)。

Pygros 制谱的核心观念之一就是“音符是绑定到判定线上的”。所以任何一个创建的音符都应该指定一条判定线。

有两种方式：
```python
with Line(0.5, 0.5):
    # 第一种方式：自动绑定
    # 在这里写的音符会自动绑定到上一行创建的判定线上
    Click(0, 0, 0.8)
# 而在这里写的就不会自动绑定
# Click(1, 0, 0.8)
# 如果你真的这样写了，程序会报错
```

```python
line = Line(0.5, 0.5)
# 第二种方式：手动绑定
# 通过指定 line 参数，手动指定要绑定的判定线
Click(0, 0, 0.8, line=line)
with Line(0.5, 0.2):
    # 显然，手动绑定的优先级要比自动绑定高
    Click(1, 0, 0.8, line=line)
```

### 7. 加！动！画！

::: warning
Pygros 目前的动画系统存在很多问题，并且很不好用（这一点从下面的文档就能看出来了）。在新版本中，我们会提供一套完全不同的动画系统，届时，这部分文档会完全作废。
:::

动画有两种，音符动画和判定线动画。相对来说，音符动画比较简单，且功能较少。

音符动画和判定线动画都是通过 `.set(xxx)` 实现的，并且支持“链式操作”，即你可以写 `line.set(xxx).set(xxx).set(xxx)` 这样子。

调用 `.set` 时，对于缺少的参数（比如调用 `line.set(5, x=0.5, y=0.5)` 时，那么 `angle` 和 `width` 就是缺少的参数），会自动继承上一个 `.set` 的值。你甚至可以“缺少所有参数”，这一点在创建连续变化型动画时很有用。

你可以认为所有的音符和判定线都会被自动执行 `.set(0, ...)`。

#### 音符动画

给出一个例子：
```python
with Line(0.5, 0.5):
    Click(5, 0, 0.5).set(3, speed=0).set(4, speed=0.5)
```
解释一下。首先创建了一条中心点为 `(0.5, 0.5)` 判定线；然后创建了一个 Click 音符，触摸时间为 5，相对位置为 0，下落速度为 0.5。

然后我给这个音符加了这样的动画：
+ 第 0 秒到第 3 秒，这个音符按照 0.5 的速度正常下落。
+ 第 3 秒，这个音符会突然停住，不再下落。
+ 第 4 秒，这个音符继续下落，速度仍为 0.5。

这是一个非常简单的例子，因为 pygros 的速度是瞬间变化的。

来看另一个：
```python
with Line(0.5, 0.5):
    Click(5, -0.2, 0.5).set(4.5).set(5, pos=0.2)
```
解释一下。首先创建了一条中心点为 `(0.5, 0.5)` 判定线；然后创建了一个 Click 音符，触摸时间为 5，相对位置为 -0.2，下落速度为 0.5。

然后我给这个音符加了这样的动画：
+ 第 0 秒到第 4.5 秒，这个音符按照 0.5 的速度正常下落。
+ 第 4.5 秒到第 5 秒，这个音符继续下落，同时从 -0.2 移动到 0.2。

Pygros 的很多动画效果都是连续变化的，比如这里的 pos。连续变化的意思是：从 “上一次你使用 `set` 传入的参数” 连续变化到 “这一次你使用 `set` 传入的参数”。

音符动画的参数只有这两个。要实现更高级的效果，请使用判定线动画。

#### 判定线动画

判定线动画的效果都是连续变化的。举一个例子：
```python
with Line(0.5, 0.5) as line:
    # ...
    line.set(1).set(2, angle=180, width=0).set(3, x=0.4, y=0.4, width=1)
```
解释一下。首先创建了一条中心点为 `(0.5, 0.5)` 判定线；然后我给这条判定线加了这样的动画：
+ 第 0 秒到第 1 秒，什么都不会发生
+ 第 1 秒到第 2 秒，旋转 180°，同时渐渐消失
+ 第 2 秒到第 3 秒，向左下移动到中心点坐标为 `(0.4, 0.4)` 的位置，同时渐渐出现

判定线动画的可选参数就是这四个：`x`, `y`, `angle`, `width`。他们都是连续变化的。

### 8. 预览

Pygros 提供了 `preview` 函数来预览你的谱面。对于最简单的使用，你只需要在最后一行写：
```python
preview()
```
即可。

当然，这样看起来效果很不好，我们要加一些东西，比如曲名、难度、背景图片啥的。
```python
preview('Fracture Ray', 'AT Lv.16', '削除 - [Arcaea] Fracture Ray.mp3', '骨折光.jpg')
```
正如你所见，第一个参数是曲名（显示在左下角），第二个参数是难度（显示在右下角），第三个参数是背景音乐，第四个参数是背景图片。

详细参数列表见 [API - preview](../api.md#preview)

## 一些技巧

好了，你现在已经学会了 pygros，快去复刻一个 Spasmodic 吧！（bushi

### Offset

前面说过，`Offset` 可以用来调延迟的。~~怎么可能只有这么简单！~~

来看一个例子（节选并改编自 `demo.py`）：
```python
with Line(0.5, 0.5) as line:
    Click(0, 0.08, spd)
    # ...
    # 略
    # ...
    Drag(23.5, -0.12, -spd)
    Offset(24)

    Click(0, 0.4, spd)
    Click(0.5, -0.4, spd)
    Click(1, 0.37, spd)
    Click(1.5, -0.37, spd)
    Click(2, 0.4, spd)
    Click(2.5, -0.4, spd)
    Click(3, 0.37, spd)
    Click(3.5, -0.37, spd)
    line.set(4)
    Click(4, 0.1, spd)
    # ...
    # 略
    # ...
    Click(71.5, 0.1, spd)
    line.set(71.5, angle=180)
    line.set(71.51, angle=0)
    Offset(72)
```

注意到：第 6 行定义了一个 Drag，触摸时间为 `23.5`；而在它之后，从第 9 行开始，触摸时间又从 0 重新开始计了。

这便是 `Offset` 的另一个用法。~~其实在本质上，这和谱面整体延迟调节是一样的。~~

另外请注意：`Offset` 是会受 `Multiplier` 影响的。

更多说明见 [API - Offset](/zh/api.md#offset)。

### Group

这个我还没测试过（（（先不写了（（（~~据说~~可以实现note集体刹车漂移啥的（（（

### 多判定线问题

首先，这是一个 BUG：如果有多条宽度为 0 的判定线集中在一个地方，你也能够看到它们。

但是，这并不影响你应该**使用多条判定线来实现复杂的动画**而不是**复杂的note变速**。
